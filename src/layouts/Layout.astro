---
import '../styles/reset.css';
import '../styles/variables.css';
import '../styles/global.css';
import '../styles/tailwind.css';
import CookieBanner from '../components/CookieBanner.astro';
import consentScript from '../scripts/consent.ts?url';

interface Props {
	title: string;
	description?: string;
	lang?: 'de' | 'en';
	currentPath?: string;
	image?: string;
	type?: string;
}

const { 
	title, 
	description = "ConnectingTheDots - Von der Idee zum erfolgreichen Unternehmen. Wir helfen dir dabei, deine Unternehmensidee zu testen, umzusetzen und zu wachsen.",
	lang = 'de', 
	currentPath = Astro.url.pathname,
	image = new URL('/images/Logo_CTD.png', Astro.site).href,
	type = 'website'
} = Astro.props;

const siteUrl = Astro.site || 'https://connectingthe.de';
const canonicalUrl = new URL(currentPath, siteUrl).href;
const fullImageUrl = image.startsWith('http') ? image : new URL(image, siteUrl).href;
---

<!doctype html>
<html lang={lang}>
	<head>
		<!-- Google Consent Mode v2 - MUSS vor Google Analytics geladen werden -->
		<script is:inline>
			// Initialisiere dataLayer
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			
			// Lade gespeicherten Consent
			let savedConsent = null;
			try {
				const stored = localStorage.getItem('cookie_consent');
				if (stored) {
					const parsed = JSON.parse(stored);
					if (parsed.version === '1.0') {
						savedConsent = parsed.consent;
					}
				}
			} catch (e) {}
			
			// Prüfe ob EWR (vereinfacht)
			const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
			const language = navigator.language.toLowerCase();
			const isEEA = timezone.startsWith('Europe/') || 
				['de', 'en-gb', 'fr', 'it', 'es', 'nl', 'pl', 'pt', 'sv', 'da', 'fi', 'el', 'cs', 'ro', 'hu', 'sk', 'sl', 'et', 'lv', 'lt', 'mt', 'ga', 'hr', 'bg'].some(lang => language.startsWith(lang));
			
			// Setze Default-Consent
			const defaultConsent = isEEA ? {
				analytics_storage: 'denied',
				ad_storage: 'denied',
				ad_user_data: 'denied',
				ad_personalization: 'denied',
			} : {
				analytics_storage: 'granted',
				ad_storage: 'granted',
				ad_user_data: 'granted',
				ad_personalization: 'granted',
			};
			
			const finalConsent = savedConsent || defaultConsent;
			
			// Setze Consent Mode Default
			gtag('consent', 'default', {
				analytics_storage: finalConsent.analytics_storage,
				ad_storage: finalConsent.ad_storage,
				ad_user_data: finalConsent.ad_user_data,
				ad_personalization: finalConsent.ad_personalization,
				wait_for_update: 500,
			});
		</script>
		
		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSB2GL7YSD"></script>
		<script is:inline>
			gtag('js', new Date());
			gtag('config', 'G-SSB2GL7YSD', {
				anonymize_ip: true,
				send_page_view: true,
				// Stelle sicher, dass der Tag erkannt wird
				page_path: window.location.pathname + window.location.search,
				page_title: document.title
			});
			
			// Debug: Stelle sicher, dass gtag verfügbar ist
			if (typeof gtag === 'function') {
				console.log('Google Analytics Tag loaded successfully');
			}
		</script>
		
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- Primary Meta Tags -->
		<title>{title}</title>
		<meta name="title" content={title} />
		<meta name="description" content={description} />
		<meta name="keywords" content={lang === 'de' ? 'Unternehmensberatung, Business Development, Startup Beratung, Marktvalidierung, E-Commerce, Performance Marketing, Interim Management, DACH Markt' : 'Business Consulting, Business Development, Startup Consulting, Market Validation, E-Commerce, Performance Marketing, Interim Management, DACH Market'} />
		<meta name="author" content="ConnectingTheDots" />
		<meta name="robots" content="index, follow" />
		<link rel="canonical" href={canonicalUrl} />
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={type} />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={fullImageUrl} />
		<meta property="og:locale" content={lang === 'de' ? 'de_DE' : 'en_US'} />
		<meta property="og:site_name" content="ConnectingTheDots" />
		
		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={canonicalUrl} />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={fullImageUrl} />
		
		<!-- Hreflang Tags für mehrsprachige Seiten -->
		{(() => {
			const pathWithoutLang = currentPath.replace(/^\/de|\/en/, '') || '/';
			const dePath = pathWithoutLang === '/' ? '/de/' : `/de${pathWithoutLang}`;
			const enPath = pathWithoutLang === '/' ? '/en/' : `/en${pathWithoutLang}`;
			return (
				<>
					<link rel="alternate" hreflang="de" href={new URL(dePath, siteUrl).href} />
					<link rel="alternate" hreflang="en" href={new URL(enPath, siteUrl).href} />
					<link rel="alternate" hreflang="x-default" href={new URL('/de/', siteUrl).href} />
				</>
			);
		})()}
		
		<!-- Favicon -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		
		<!-- Preconnect für Performance -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
		/>
		
		<!-- Structured Data (JSON-LD) -->
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "Organization",
			"name": "ConnectingTheDots",
			"url": siteUrl,
			"logo": new URL('/images/Logo_CTD.png', siteUrl).href,
			"description": description,
			"sameAs": [
				"https://www.linkedin.com/company/connectingthedots"
			],
			"contactPoint": {
				"@type": "ContactPoint",
				"contactType": "customer service",
				"availableLanguage": ["German", "English"]
			}
		})} />
		
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "WebSite",
			"name": "ConnectingTheDots",
			"url": siteUrl,
			"description": description,
			"inLanguage": lang === 'de' ? 'de-DE' : 'en-US',
			"potentialAction": {
				"@type": "SearchAction",
				"target": {
					"@type": "EntryPoint",
					"urlTemplate": `${siteUrl}/?q={search_term_string}`
				},
				"query-input": "required name=search_term_string"
			}
		})} />
		
		{currentPath.includes('/de/') || currentPath === '/de' || currentPath === '/' ? (
			<script type="application/ld+json" set:html={JSON.stringify({
				"@context": "https://schema.org",
				"@type": "Service",
				"serviceType": "Business Consulting",
				"provider": {
					"@type": "Organization",
					"name": "ConnectingTheDots"
				},
				"areaServed": {
					"@type": "Country",
					"name": ["DE", "AT", "CH"]
				},
				"hasOfferCatalog": {
					"@type": "OfferCatalog",
					"name": "Business Services",
					"itemListElement": [
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "Kundenakquise",
								"description": "Wir helfen dir dabei, deine Zielgruppe zu finden und zu erreichen."
							}
						},
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "Schnelle Umsetzung",
								"description": "Turn ideas into testable MVPs within days."
							}
						},
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "E-Commerce Vertrieb",
								"description": "Wir helfen dir dabei, deinen Online-Shop aufzubauen und zu betreiben."
							}
						},
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "Performance Marketing",
								"description": "Wir optimieren deine Marketing-Kampagnen für maximale Performance und ROI."
							}
						},
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "Interim Management",
								"description": "Wir unterstützen dich vorübergehend bei Marketing, Vertrieb oder digitalen Projekten."
							}
						}
					]
				}
			})} />
		) : null}
	</head>
	<body>
		<slot />
		<CookieBanner lang={lang} currentPath={currentPath} />
		<script type="module" src={consentScript}></script>
		
		<!-- Netlify Identity Widget - für Token-Verarbeitung aus E-Mail-Links -->
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
		<script is:inline>
			// Initialisiere Netlify Identity, um Token aus E-Mail-Links zu verarbeiten
			(function() {
				let tokenProcessed = false;
				let shouldRedirectToAdmin = false;
				
				// Prüfe sofort ob Token in der URL vorhanden ist (BEVOR das Widget geladen wird)
				const hash = window.location.hash;
				const hasInviteToken = hash && hash.includes('invite_token');
				const hasRecoveryToken = hash && hash.includes('recovery_token');
				const hasConfirmationToken = hash && hash.includes('confirmation_token');
				
				if (hasInviteToken || hasRecoveryToken || hasConfirmationToken) {
					console.log('Token in URL gefunden:', hash);
					// Verhindere automatische Weiterleitung, bis Token verarbeitet ist
					shouldRedirectToAdmin = false;
				}
				
				// Warte bis das Widget geladen ist
				function initIdentity() {
					if (window.netlifyIdentity) {
						// Event-Handler für Token-Verarbeitung
						window.netlifyIdentity.on("init", user => {
							console.log('Identity init, user:', user);
							
							// Wenn Token vorhanden und User noch nicht eingeloggt
							if ((hasInviteToken || hasRecoveryToken || hasConfirmationToken) && !user && !tokenProcessed) {
								console.log('Token gefunden, User nicht eingeloggt - öffne Modal...');
								tokenProcessed = true;
								
								// Warte kurz, dann öffne das entsprechende Modal
								setTimeout(() => {
									if (hasInviteToken) {
										console.log('Öffne Signup-Modal für Passwort-Setup...');
										window.netlifyIdentity.open('signup');
									} else if (hasRecoveryToken) {
										console.log('Öffne Recovery-Modal für Passwort-Reset...');
										window.netlifyIdentity.open('recovery');
									} else if (hasConfirmationToken) {
										console.log('Bestätigungs-Token gefunden...');
										// Für Bestätigung wird automatisch weitergeleitet
									}
								}, 800);
							} else if (user) {
								console.log('User bereits eingeloggt');
								// User ist bereits eingeloggt, leite zur Admin-Seite weiter
								if (shouldRedirectToAdmin) {
									setTimeout(() => {
										if (window.location.pathname !== '/admin' && !window.location.pathname.includes('/admin')) {
											window.location.href = '/admin';
										}
									}, 500);
								}
							}
						});
						
						// Nach erfolgreichem Login, leite zur Admin-Seite weiter
						window.netlifyIdentity.on("login", (user) => {
							console.log('Login erfolgreich, User:', user);
							tokenProcessed = true;
							shouldRedirectToAdmin = true;
							
							// Warte kurz, dann leite zur Admin-Seite weiter
							setTimeout(() => {
								if (window.location.pathname !== '/admin' && !window.location.pathname.includes('/admin')) {
									window.location.href = '/admin';
								} else {
									// Wenn bereits auf /admin, lade die Seite neu
									window.location.reload();
								}
							}, 1500);
						});
						
						// Nach erfolgreichem Signup (Passwort-Setup), leite zur Admin-Seite weiter
						window.netlifyIdentity.on("signup", (user) => {
							console.log('Signup/Passwort-Setup erfolgreich, User:', user);
							tokenProcessed = true;
							shouldRedirectToAdmin = true;
							
							// Warte etwas länger, damit der User das Passwort setzen kann
							setTimeout(() => {
								if (window.location.pathname !== '/admin' && !window.location.pathname.includes('/admin')) {
									window.location.href = '/admin';
								} else {
									// Wenn bereits auf /admin, lade die Seite neu
									window.location.reload();
								}
							}, 2000);
						});
						
						// Error-Handler für Token-Fehler
						window.netlifyIdentity.on("error", (err) => {
							console.error('Identity error:', err);
							if (hasInviteToken || hasRecoveryToken || hasConfirmationToken) {
								console.error('Fehler beim Verarbeiten des Tokens:', err);
								// Zeige Fehlermeldung
								alert('Fehler beim Verarbeiten des Links. Bitte versuche es erneut oder kontaktiere den Administrator.');
							}
						});
						
						// Initialisiere das Widget (wichtig für Token-Verarbeitung)
						window.netlifyIdentity.init();
					} else {
						// Retry nach kurzer Verzögerung
						setTimeout(initIdentity, 100);
					}
				}
				
				// Starte Initialisierung sofort
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initIdentity);
				} else {
					initIdentity();
				}
			})();
		</script>
	</body>
</html>

