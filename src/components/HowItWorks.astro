---
import { getTranslations, type Language } from '../i18n/translations';

interface Props {
  lang?: Language;
}

const { lang = 'de' } = Astro.props;
const t = getTranslations(lang);
---

<section id="how-it-works" class="bg-white py-20 px-4 relative overflow-hidden">
  <!-- Subtle connecting dots background -->
  <div class="absolute inset-0 opacity-20">
    <!-- ConnectingDots Hintergrund-Effekt -->
  </div>

  <div class="max-w-7xl mx-auto relative z-10">
    <div class="text-center mb-16">
      <h2 
        id="how-it-works-title"
        class="text-3xl lg:text-4xl mb-6 opacity-0"
      >
        {t.howItWorks.title}
      </h2>
      <p 
        id="how-it-works-subtitle"
        class="text-lg text-muted-foreground max-w-2xl mx-auto mb-12 opacity-0"
      >
        {t.howItWorks.subtitle}
      </p>
      
      <!-- Video Placeholder -->
      <div 
        id="video-placeholder"
        class="bg-secondary rounded-3xl p-8 mb-16 max-w-4xl mx-auto relative overflow-hidden group opacity-0"
      >
        <!-- Animated corner dots -->
        <div 
          id="corner-dot-1"
          class="absolute top-4 left-4 w-2 h-2 bg-accent rounded-full"
        ></div>
        <div 
          id="corner-dot-2"
          class="absolute top-4 right-4 w-2 h-2 bg-accent rounded-full"
        ></div>
        <div 
          id="corner-dot-3"
          class="absolute bottom-4 left-4 w-2 h-2 bg-accent rounded-full"
        ></div>
        <div 
          id="corner-dot-4"
          class="absolute bottom-4 right-4 w-2 h-2 bg-accent rounded-full"
        ></div>

        <div class="aspect-video bg-primary/10 rounded-2xl flex items-center justify-center relative overflow-hidden cursor-pointer">
          <!-- Subtle gradient overlay -->
          <div class="absolute inset-0 bg-gradient-to-br from-accent/10 to-primary/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
          
          <div class="text-center relative z-10">
            <div 
              id="play-button"
              class="w-20 h-20 bg-accent rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-accent/20"
            >
              <svg class="w-8 h-8 text-accent-foreground" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
            <p class="text-lg text-muted-foreground">
              {t.howItWorks.videoPlaceholder}
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="grid md:grid-cols-3 gap-8 relative">
      <!-- Connecting lines between steps -->
      <div class="hidden md:block absolute top-10 left-1/4 right-1/4 h-1">
        <svg id="connecting-line" class="w-full h-full" viewBox="0 0 100 10">
          <line
            x1="0"
            y1="5"
            x2="100"
            y2="5"
            stroke="#7be0b7"
            stroke-width="2"
            stroke-dasharray="5,5"
            style="stroke-dashoffset: 100;"
          />
        </svg>
      </div>

      <!-- Step 1: Validate -->
      <div class="step-card opacity-0" data-index="0">
        <div class="text-center relative">
          <div class="step-content card-surface gradient-validate">
            <div class="icon-badge">
              <svg class="w-10 h-10 text-accent-foreground relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>

            <h3 class="text-xl mb-3">{t.howItWorks.step1.title}</h3>
            <p class="text-muted-foreground leading-relaxed">
              {t.howItWorks.step1.description}
            </p>

            <!-- Arrow between steps -->
            <div class="hidden md:block absolute top-10 -right-12 text-accent opacity-0 arrow-right">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Build -->
      <div class="step-card opacity-0" data-index="1">
        <div class="text-center relative">
          <div class="step-content card-surface gradient-build">
            <div class="icon-badge">
              <svg class="w-10 h-10 text-accent-foreground relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </div>

            <h3 class="text-xl mb-3">{t.howItWorks.step2.title}</h3>
            <p class="text-muted-foreground leading-relaxed">
              {t.howItWorks.step2.description}
            </p>

            <!-- Arrow between steps -->
            <div class="hidden md:block absolute top-10 -right-12 text-accent opacity-0 arrow-right">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Scale -->
      <div class="step-card opacity-0" data-index="2">
        <div class="text-center relative">
          <div class="step-content card-surface gradient-scale">
            <div class="icon-badge">
              <svg class="w-10 h-10 text-accent-foreground relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M7 14l4 4L21 8"></path>
              </svg>
            </div>

            <h3 class="text-xl mb-3">{t.howItWorks.step3.title}</h3>
            <p class="text-muted-foreground leading-relaxed">
              {t.howItWorks.step3.description}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (function() {
    function initHowItWorks() {
      // Stelle sicher, dass no-js entfernt wurde
      document.documentElement.classList.remove('no-js');
      
      // Fade in title and subtitle
      const title = document.getElementById('how-it-works-title');
      const subtitle = document.getElementById('how-it-works-subtitle');
      const videoPlaceholder = document.getElementById('video-placeholder');
      
      // Retry if elements not found
      if (!title || !subtitle || !videoPlaceholder) {
        setTimeout(initHowItWorks, 100);
        return;
      }
    
    if (title) {
      setTimeout(() => {
        title.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        title.style.opacity = '1';
        title.style.transform = 'translateY(0)';
      }, 100);
    }

    if (subtitle) {
      setTimeout(() => {
        subtitle.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        subtitle.style.opacity = '1';
        subtitle.style.transform = 'translateY(0)';
      }, 200);
    }

    if (videoPlaceholder) {
      setTimeout(() => {
        videoPlaceholder.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        videoPlaceholder.style.opacity = '1';
        videoPlaceholder.style.transform = 'scale(1)';
      }, 300);
    }

    // Animate corner dots
    const cornerDots = ['corner-dot-1', 'corner-dot-2', 'corner-dot-3', 'corner-dot-4'];
    const delays = [0, 0.5, 1, 1.5];
    
    cornerDots.forEach((id, index) => {
      const dot = document.getElementById(id);
      if (dot) {
        setInterval(() => {
          dot.style.transform = 'scale(1)';
          dot.style.opacity = '0.5';
          setTimeout(() => {
            dot.style.transition = 'all 0.5s ease';
            dot.style.transform = 'scale(1.5)';
            dot.style.opacity = '1';
            setTimeout(() => {
              dot.style.transform = 'scale(1)';
              dot.style.opacity = '0.5';
            }, 500);
          }, 100);
        }, 2000 + delays[index] * 1000);
      }
    });

    // Animate connecting line
    const connectingLine = document.querySelector('#connecting-line line');
    if (connectingLine) {
      setTimeout(() => {
        connectingLine.style.transition = 'stroke-dashoffset 1.5s ease';
        connectingLine.style.strokeDashoffset = '0';
      }, 800);
    }

    // Step cards animation
    const stepCards = document.querySelectorAll('.step-card');
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const card = entry.target as HTMLElement;
          const index = parseInt(card.getAttribute('data-index') || '0');
          const delay = index * 200 + 300;
          
          setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
            
            // Show arrow
            const arrow = card.querySelector('.arrow-right');
            if (arrow) {
              setTimeout(() => {
                arrow.style.transition = 'opacity 0.5s ease';
                arrow.style.opacity = '0.5';
              }, 300);
            }
          }, delay);
        }
      });
    }, observerOptions);

    stepCards.forEach((card) => {
      card.style.transform = 'translateY(50px)';
      observer.observe(card);
    });

    // Hover effects
    const playButton = document.getElementById('play-button');
    if (playButton) {
      playButton.addEventListener('mouseenter', () => {
        playButton.style.transform = 'scale(1.1) rotate(5deg)';
      });
      playButton.addEventListener('mouseleave', () => {
        playButton.style.transform = 'scale(1) rotate(0deg)';
      });
    }

    stepCards.forEach((card) => {
      const stepContent = card.querySelector('.step-content');
      if (stepContent) {
        card.addEventListener('mouseenter', () => {
          stepContent.style.transform = 'translateY(-10px)';
        });
        card.addEventListener('mouseleave', () => {
          stepContent.style.transform = 'translateY(0)';
        });
      }
    });
  }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHowItWorks);
    } else {
      setTimeout(initHowItWorks, 0);
    }
  })();
</script>

<style>
  #how-it-works-title,
  #how-it-works-subtitle {
    transform: translateY(20px);
  }

  #video-placeholder {
    transform: scale(0.95);
  }

  /* Fallback: Wenn JavaScript nicht läuft, zeige Content trotzdem */
  .no-js #how-it-works-title,
  .no-js #how-it-works-subtitle,
  .no-js #video-placeholder,
  .no-js .step-card {
    opacity: 1 !important;
    transform: none !important;
  }
  
  /* Sicherheitsfallback: Zeige Content auch wenn Skripte nicht ausgeführt werden */
  #how-it-works-title,
  #how-it-works-subtitle,
  #video-placeholder,
  .step-card {
    animation: fadeInFallback 0.1s ease 1s forwards;
  }
  
  @keyframes fadeInFallback {
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .step-content {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease, border 0.3s ease;
  }

  .step-card:hover .step-content {
    transform: translateY(-12px);
    box-shadow: 0 25px 45px -15px rgba(123, 224, 183, 0.3);
  }

  .icon-badge {
    width: 5rem;
    height: 5rem;
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem auto;
    box-shadow: 0 12px 25px rgba(123, 224, 183, 0.25);
    background: var(--accent, #7be0b7);
    position: relative;
  }

  .card-surface {
    border: 1px solid rgba(123, 224, 183, 0.1);
    border-radius: 1.75rem;
    background: #fff;
    position: relative;
    overflow: hidden;
    padding: 2rem;
  }

  .card-surface::before {
    content: "";
    position: absolute;
    inset: -40%;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .step-card:hover .card-surface::before {
    opacity: 1;
  }

  .gradient-validate::before {
    background: radial-gradient(circle at top, rgba(123, 224, 183, 0.35), transparent 55%);
  }

  .gradient-build::before {
    background: radial-gradient(circle at top, rgba(148, 211, 236, 0.35), transparent 55%);
  }

  .gradient-scale::before {
    background: radial-gradient(circle at top, rgba(220, 180, 255, 0.35), transparent 55%);
  }

  .play-button {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>
